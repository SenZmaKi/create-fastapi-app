# Multi-stage build for Python FastAPI application using uv properly
FROM ghcr.io/astral-sh/uv:python3.11-bookworm-slim AS builder

WORKDIR /{{ app_name }}

COPY pyproject.toml uv.lock ./
RUN uv sync --frozen --no-dev


FROM python:3.11-slim

ENV FASTAPI_PORT=8000
ENV PATH="/{{ app_name }}/.venv/bin:/usr/local/bin:$PATH"

WORKDIR /{{ app_name }}

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /{{ app_name }}

# Copy venv
COPY --from=builder --chown=appuser:appuser /{{ app_name }}/.venv /{{ app_name }}/.venv

# Copy uv into the final image (location depends on base image, so copy both common paths)
COPY --from=builder /usr/local/bin/uv /usr/local/bin/uv
COPY --from=builder /usr/local/bin/uvx /usr/local/bin/uvx

RUN chmod +x /usr/local/bin/uv /usr/local/bin/uvx || true

RUN mkdir -p logs data && \
    chown -R appuser:appuser logs data

COPY --chown=appuser:appuser pyproject.toml alembic.ini ./
COPY --chown=appuser:appuser scripts/ scripts/
COPY --chown=appuser:appuser alembic/ alembic/
COPY --chown=appuser:appuser app/ app/

USER appuser

EXPOSE ${FASTAPI_PORT}

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${FASTAPI_PORT}/api/health || exit 1

# Start using uv
CMD ["uv", "run", "--no-sync", "python", "-m", "app"]
